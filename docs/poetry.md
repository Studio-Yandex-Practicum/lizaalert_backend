## Poetry
У Poetry два основных файла в корне проекта:  

***pyproject.toml*** - описывает зависимости верхнего уровня (абстрактные),  те которые добавляет пользователь руками (django,  RF, flake8 и т.д.)  
***poetry.lock*** - содержит детерминированный снимок всех зависимостей и их  подзависимостей с конкретными версиями и хеш-суммами пакетов. Создается  автоматически, руками в него ничего не вносится.  
  
### Принцип poetry:  
Если при добавлении новой библиотеки в *pyproject.toml* её подзависимости  будут совместимы с теми, что уже зафиксированы в *poetry.lock* (пусть они и не самые свежие), тогда имеющиеся в *poetry.lock* обновлены не будут, добавятся  только недостающие.  

Это позволяет фиксировать окружение для деплоя проекта в неизменном рабочем состоянии. Это и накладывает некоторые дополнительные сложности,  в том числе при merge.  
  
### Способы добавления/удаления библиотек:
Есть два рабочих способа добавления или удаления новой библиотеки  (обратите внимание, версии лучше указывать полностью фиксированные):  
1) Через командную строку, например:  
   `poetry add gunicorn="^20.1.0" django="^3.2.12"`

   `poetry add --dev flake8="^4.0.1"`
 
   `poetry remove flake8`  
  
2) Напрямую вписав или удалив библиотеку в нужную секцию  
(dependencies или dev-dependencies) в файле *pyproject.toml*. Но после  этого все равно нужно применить команду `poetry add <new_package>`, чтобы  в lock файле отобразились изменения (недоработанный костыль в poetry). 
Например, можно добавить и удалить мелкую библиотеку без зависимостей:  
    `poetry add pycowsay && poetry remove pycowsay`
  

#### Внимание!  
**НЕ** используйте следующие команды, т.к. они полностью обновляют lock файл:  
`poetry lock`  
`poetry update`  
  
  
### Концепция разрешения merge конфликтов:   
1) 
- ***poetry.lock*** - ВСЕГДА берем в неизменном виде из сливаемой ветки.    
- ***pyproject.toml*** - можно взять в неизменном виде, а можно смержить, воркфлоу  отличается незначительно (об этом ниже).
  
2) 
- Если *pyproject.toml* взяли в неизменном виде, то нужно добавить свои библиотеки описанным выше первым способом:    
  `poetry add <package1> <package2>`   
 - Если *pyproject.toml* смержили, т.е. в нем уже перечислены ваши добавленные 
   библиотеки, то применяем второй способ:   
   `poetry add pycowsay && poetry remove pycowsay`  

  
 #### Один из возможных примеров разрешения merge конфликта:    
 `git merge main` *(сливаем ветку main к себе, возник конфликт)*    
 `git checkout --theirs poetry.lock` *(берем весь файл из ветки master)*

 `...` *(разрешаем конфликты в других файлах и в pyproject.toml)*    

 `poetry add pycowsay && poetry remove pycowsay`
 `git add .`    
`git merge --continue` *(коммитим)*
